<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แท็กงานของมิ้ว</title>

    <!-- 1. โหลด Tailwind CSS สำหรับการจัดสไตล์ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script>
        // Set initial theme to prevent flash of wrong theme
        if (localStorage.getItem('mew-theme') === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- 2. โหลดไลบรารีที่จำเป็นสำหรับ React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- 3. โหลด Babel เพื่อแปลโค้ด JSX ในเบราว์เซอร์ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. โหลดฟอนต์ Kanit จาก Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
      /* กำหนดฟอนต์ Kanit ให้กับทุกส่วนของหน้าเว็บ */
      body {
        font-family: 'Kanit', sans-serif;
      }
    </style>
</head>
<body>

    <!-- 5. นี่คือจุดที่แอป React ของเราจะถูกแสดงผล -->
    <div id="root"></div>

    <!-- 6. โค้ด React ทั้งหมดจะอยู่ในนี้ และต้องกำหนด type="text/babel" -->
    <script type="text/babel">
        // --- Helper Functions ---
        const getDaysInMonth = (year, month) => {
          return new Date(year, month, 0).getDate();
        };

        const monthNames = [
          "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
          "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
        ];
        
        // --- Status Configuration ---
        const STATUSES = {
          hold: { text: 'Hold', symbol: '', color: 'bg-gray-200 text-gray-800 dark:bg-slate-600 dark:text-slate-100', hover: 'hover:bg-gray-300 dark:hover:bg-slate-700', rowColor: 'odd:bg-slate-50/70 even:bg-white dark:bg-slate-800/30', rowHover: 'hover:bg-slate-100 dark:hover:bg-slate-700/50' },
          pending: { text: 'Pending ?', color: 'bg-yellow-200 text-yellow-800 dark:bg-amber-400 dark:text-amber-900', hover: 'hover:bg-yellow-300 dark:hover:bg-amber-500', rowColor: 'bg-yellow-100 dark:bg-amber-400/10', rowHover: 'hover:bg-yellow-200 dark:hover:bg-amber-400/20' },
          done: { text: 'Done ✓', color: 'bg-emerald-200 text-emerald-800 dark:bg-emerald-500 dark:text-white', hover: 'hover:bg-emerald-300 dark:hover:bg-emerald-600', rowColor: 'bg-emerald-100 dark:bg-emerald-500/10', rowHover: 'hover:bg-emerald-200 dark:hover:bg-emerald-500/20' },
          cannot: { text: 'Cannot ✗', color: 'bg-red-200 text-red-800 dark:bg-red-600 dark:text-white', hover: 'hover:bg-red-300 dark:hover:bg-red-700', rowColor: 'bg-red-100 dark:bg-red-500/10', rowHover: 'hover:bg-red-200 dark:hover:bg-red-500/20' },
        };
        const STATUS_CYCLE = ['hold', 'pending', 'done', 'cannot'];

        // --- Default Frequently Used Tasks ---
        const DEFAULT_FREQUENT_TASKS = [
          "ทำความสะอาดฟิลเตอร์แอร์",
          "ไม้จูงม่านหลุด",
          "แก้วอล (แก้ไขงานวอลเปเปอร์)",
          "แอร์กระพริบ",
          "น้ำรั่ว",
          "เปลี่ยนถ่านตาชั่ง",
          "ผนังร้าว",
          "ไฟตู้ผ้ากระพริบ",
          "ขัดเคาท์เตอร์ครัว",
          "น้ำไม่ร้อน"
        ];

        // --- SVG Icons ---
        const BackArrowIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" /></svg> );
        const PlusIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg> );
        const TrashIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg> );
        const EditIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg> );
        const SearchIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg> );
        const ExportIcon = () => ( <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zM10 4a.75.75 0 01.75.75V4a.75.75 0 01-.75.75z" clipRule="evenodd" /><path fillRule="evenodd" d="M4 10a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" clipRule="evenodd" /><path d="M10 12a1 1 0 100 2 1 1 0 000-2z" /></svg> );
        const SuccessIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-green-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>);
        const ChevronLeftIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg>);
        const ChevronRightIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>);
        const CopyIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M4 3a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H4z" /></svg>);
        const SunIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>);
        const MoonIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>);

        // --- Components ---
        const { useState, useEffect, useMemo, useRef } = React;

        const Notification = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(() => onClose(), 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            return (
                <div className="fixed top-24 right-5 z-50 bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg rounded-xl shadow-2xl p-4 flex items-center animate-fade-in-down border border-gray-200 dark:border-slate-700">
                    <SuccessIcon />
                    <p className="text-gray-800 dark:text-white font-semibold">{message}</p>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50 animate-fade-in">
                    <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-8 w-full max-w-md m-4 border border-slate-700">
                        <h3 className="text-xl font-bold text-gray-900 dark:text-white">{title}</h3>
                        <p className="text-gray-600 dark:text-slate-300 mt-2 mb-8">{message}</p>
                        <div className="flex justify-end gap-4">
                            <button onClick={onClose} className="py-2 px-5 bg-gray-200 dark:bg-slate-600 dark:hover:bg-slate-700 hover:bg-gray-300 text-gray-800 dark:text-white font-semibold rounded-lg transition-all duration-200">ยกเลิก</button>
                            <button onClick={onConfirm} className="py-2 px-5 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-all duration-200 shadow-lg shadow-red-500/30">ยืนยันการลบ</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ManageFrequentTasksModal = ({ isOpen, onClose, frequentTasks, onAdd, onDelete }) => {
            const [newItem, setNewItem] = useState('');
            if (!isOpen) return null;

            const handleAdd = () => {
                if (newItem.trim() && !frequentTasks.includes(newItem.trim())) {
                    onAdd(newItem.trim());
                    setNewItem('');
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50">
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-lg flex flex-col border border-gray-200 dark:border-slate-700" style={{maxHeight: '80vh'}}>
                        <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-4">จัดการรายการใช้บ่อย</h3>
                        <div className="flex gap-2 mb-4">
                            <input type="text" value={newItem} onChange={(e) => setNewItem(e.target.value)} placeholder="เพิ่มรายการใหม่..." className="p-2 bg-gray-100 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-800 dark:text-white rounded-lg w-full"/>
                            <button onClick={handleAdd} className="bg-sky-600 dark:bg-amber-500 hover:bg-sky-700 dark:hover:bg-amber-600 text-white px-4 py-2 rounded-lg">เพิ่ม</button>
                        </div>
                        <div className="flex-grow overflow-y-auto border border-gray-200 dark:border-slate-700 rounded-lg p-2">
                            {frequentTasks.map((item, index) => (
                                <div key={index} className="flex justify-between items-center p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-md">
                                    <span className="text-gray-700 dark:text-gray-300">{item}</span>
                                    <button onClick={() => onDelete(item)} className="text-red-500 hover:text-red-400"><TrashIcon /></button>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-end mt-6">
                            <button onClick={onClose} className="py-2 px-4 bg-gray-200 dark:bg-slate-600 hover:bg-gray-300 dark:hover:bg-slate-700 text-gray-800 dark:text-white rounded-lg transition-colors">ปิด</button>
                        </div>
                    </div>
                </div>
            );
        };

        const TaskForm = ({ taskToEdit, onSave, onCancelEdit, onManageFrequentTasks, onBatchAdd, suggestionsSource }) => {
            const [room, setRoom] = useState('');
            const [description, setDescription] = useState('');
            const [status, setStatus] = useState('hold');
            const [error, setError] = useState('');
            const [filteredSuggestions, setFilteredSuggestions] = useState([]);
            const [batchText, setBatchText] = useState('');
            const isEditing = taskToEdit !== null;
            const roomInputRef = useRef(null);
            const descriptionWrapperRef = useRef(null);

            useEffect(() => {
                if (taskToEdit) {
                    setRoom(taskToEdit.room === 'N/A' ? '' : taskToEdit.room);
                    setDescription(taskToEdit.description);
                    setStatus(taskToEdit.status);
                    setError('');
                } else {
                    setRoom('');
                    setDescription('');
                    setStatus('hold');
                    setError('');
                }
                setTimeout(() => {
                    if (roomInputRef.current) {
                        roomInputRef.current.focus();
                    }
                }, 100);
            }, [taskToEdit]);
            
            useEffect(() => {
                // ฟังก์ชันสำหรับปิดกล่องคำแนะนำเมื่อคลิกนอกพื้นที่
                const handleClickOutside = (event) => {
                    if (descriptionWrapperRef.current && !descriptionWrapperRef.current.contains(event.target)) {
                        setFilteredSuggestions([]);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [descriptionWrapperRef]);
            
             const resetForm = () => {
                setRoom('');
                setDescription('');
                setStatus('hold');
                setError('');
                if(isEditing) {
                    onCancelEdit();
                } else {
                    roomInputRef.current?.focus();
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!description.trim()) {
                    setError('กรุณาใส่รายการซ่อม');
                    return;
                }
                setError('');
                const taskData = isEditing 
                    ? { ...taskToEdit, room: room.trim() || 'N/A', description: description.trim(), status }
                    : { id: Date.now(), room: room.trim() || 'N/A', description: description.trim(), status };
                
                onSave(taskData, isEditing);
                
                if (!isEditing) {
                    resetForm();
                }
            };
            
            const handleBatchAddClick = () => {
                if (batchText.trim()) {
                    onBatchAdd(batchText);
                    setBatchText('');
                }
            };

            const handleDescriptionChange = (e) => {
                const value = e.target.value;
                setDescription(value);

                if (value.trim()) {
                    const lowercasedValue = value.toLowerCase();
                    // ค้นหาและแสดงคำแนะนำ
                    const suggestions = suggestionsSource
                        .filter(suggestion => 
                            suggestion.toLowerCase().includes(lowercasedValue) && 
                            suggestion.toLowerCase() !== lowercasedValue // ไม่ต้องแสดงถ้าพิมพ์ตรงกันเป๊ะ
                        )
                        .slice(0, 10); // แสดงสูงสุด 10 รายการ
                    setFilteredSuggestions(suggestions);
                } else {
                    setFilteredSuggestions([]);
                }
            };

            const handleSuggestionClick = (suggestion) => {
                setDescription(suggestion);
                setFilteredSuggestions([]); // ซ่อนกล่องคำแนะนำ
            };

            return (
                <form onSubmit={handleSubmit} className="relative z-20 bg-white/60 dark:bg-slate-800/50 backdrop-blur-xl rounded-2xl p-6 mb-8 border border-gray-200/80 dark:border-slate-700 shadow-lg shadow-gray-400/10 dark:shadow-black/20">
                    <div className="mb-4 p-4 border border-dashed border-slate-400 dark:border-slate-600 rounded-lg">
                        <label className="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">วางหลายรายการจาก LINE ที่นี่ (Batch Add)</label>
                        <textarea value={batchText} onChange={(e) => setBatchText(e.target.value)} className="p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-800 dark:text-white rounded-lg w-full" placeholder={"501 แอร์ไม่เย็น\n503 ก๊อกน้ำรั่ว"} rows="3"></textarea>
                        <button type="button" onClick={handleBatchAddClick} className="mt-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg">เพิ่มหลายรายการ</button>
                    </div>
                    <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-5 border-t border-slate-200 dark:border-slate-700 pt-4">{isEditing ? 'แก้ไขรายการ' : 'เพิ่มรายการใหม่ (ทีละรายการ)'}</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input ref={roomInputRef} type="text" placeholder="เลขห้อง (ถ้ามี)" value={room} onChange={(e) => setRoom(e.target.value)} className="p-3 bg-gray-50 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-800 dark:text-white rounded-lg focus:ring-2 focus:ring-sky-500 dark:focus:ring-amber-500 focus:outline-none transition-all duration-200"/>
                        <div className="relative md:col-span-2" ref={descriptionWrapperRef}>
                            <input 
                                type="text" 
                                placeholder="* รายการซ่อม (พิมพ์เพื่อค้นหา)" 
                                value={description} 
                                onChange={handleDescriptionChange} 
                                onFocus={handleDescriptionChange} // แสดงคำแนะนำเมื่อ focus
                                autoComplete="off" // ปิด autocomplete ของเบราว์เซอร์
                                className="p-3 bg-gray-50 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-800 dark:text-white rounded-lg focus:ring-2 focus:ring-sky-500 dark:focus:ring-amber-500 focus:outline-none transition-shadow w-full"
                            />
                            <div className="absolute top-1/2 right-3 transform -translate-y-1/2 flex gap-2">
                                <button type="button" onClick={onManageFrequentTasks} className="text-sm bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-1 px-3 rounded-md">จัดการ</button>
                            </div>
                            {/* ส่วนแสดงรายการแนะนำ */}
                            {filteredSuggestions.length > 0 && (
                                <div className="absolute z-30 mt-2 w-full bg-white dark:bg-slate-800 rounded-md shadow-lg border border-gray-200 dark:border-slate-700 max-h-48 overflow-y-auto">
                                    <ul className="py-1">
                                        {filteredSuggestions.map((suggestion, index) => (
                                            <li key={index}>
                                                <a href="#" onClick={(e) => {
                                                    e.preventDefault();
                                                    handleSuggestionClick(suggestion);
                                                }} className="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700">
                                                    {suggestion}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mt-5">
                        <div className="w-full sm:w-auto">
                            <label className="block text-gray-700 dark:text-slate-300 text-sm font-bold mb-2" htmlFor="status">สถานะ</label>
                            <select id="status" value={status} onChange={(e) => setStatus(e.target.value)} className="p-3 bg-gray-50 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-gray-800 dark:text-white rounded-lg w-full focus:ring-2 focus:ring-sky-500 dark:focus:ring-amber-500 focus:outline-none">
                                {STATUS_CYCLE.map(statusKey => (<option key={statusKey} value={statusKey}>{STATUSES[statusKey].text}</option>))}
                            </select>
                        </div>
                        <div className="flex items-center gap-3 self-end pt-4 sm:pt-0">
                            {isEditing && <button type="button" onClick={onCancelEdit} className="bg-gray-200 dark:bg-slate-600 hover:bg-gray-300 dark:hover:bg-slate-700 text-gray-800 dark:text-white font-bold py-3 px-6 rounded-lg transition-colors">ยกเลิก</button>}
                            <button type="submit" className="w-full sm:w-auto flex items-center justify-center bg-sky-600 hover:bg-sky-700 dark:bg-amber-500 dark:hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg hover:shadow-sky-500/40 dark:hover:shadow-amber-500/40 transform hover:-translate-y-0.5"><PlusIcon /> {isEditing ? 'บันทึกการแก้ไข' : 'เพิ่มรายการ'}</button>
                        </div>
                    </div>
                    {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                </form>
            );
        };

        const TaskView = ({ year, month, day, tasksForDay, onAddTask, onUpdateTask, onDeleteTask, onBatchAdd, onBack, onPrevDay, onNextDay, showNotification, frequentTasks, onManageFrequentTasks, suggestionsSource }) => {
            const [taskToEdit, setTaskToEdit] = useState(null);
            const [taskToDelete, setTaskToDelete] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('default');

            const handleSaveTask = (taskData, isEditing) => {
                if(isEditing) {
                    onUpdateTask(taskData);
                    showNotification('บันทึกการแก้ไขแล้ว');
                } else {
                    onAddTask(taskData);
                    showNotification('เพิ่มรายการสำเร็จ');
                }
                setTaskToEdit(null);
            };

            const handleDeleteConfirm = () => {
                if(taskToDelete) {
                    onDeleteTask(taskToDelete.id);
                    showNotification('ลบรายการแล้ว');
                    setTaskToDelete(null);
                }
            };

            const handleStatusChange = (task, newStatus) => {
                onUpdateTask({ ...task, status: newStatus });
            };
            
            const handleCopyDescription = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('คัดลอกรายการซ่อมแล้ว!');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    showNotification('ไม่สามารถคัดลอกได้');
                }
                document.body.removeChild(textArea);
            };

            const sortedAndFilteredTasks = useMemo(() => {
                let sortedTasks = [...tasksForDay];

                if (sortBy === 'status') {
                    const statusPriority = { pending: 1, hold: 2, cannot: 3, done: 4 };
                    sortedTasks.sort((a, b) => statusPriority[a.status] - statusPriority[b.status]);
                } else if (sortBy === 'room') {
                    sortedTasks.sort((a, b) => a.room.localeCompare(b.room, undefined, { numeric: true }));
                }

                if (!searchTerm) return sortedTasks;
                return sortedTasks.filter(task => 
                    task.room.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    task.description.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [tasksForDay, searchTerm, sortBy]);

            return (
                <div className="p-4 sm:p-6 md:p-8 min-h-screen w-full">
                    <ConfirmationModal isOpen={taskToDelete !== null} onClose={() => setTaskToDelete(null)} onConfirm={handleDeleteConfirm} title="ยืนยันการลบ" message={`คุณแน่ใจหรือไม่ว่าต้องการลบรายการ "${taskToDelete?.description}"?`}/>
                    <div className="max-w-7xl mx-auto">
                        <button onClick={onBack} className="flex items-center bg-white/80 dark:bg-white/10 backdrop-blur-sm hover:bg-white dark:hover:bg-white/20 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-full transition-all duration-300 z-10 shadow-md mb-4"><BackArrowIcon /> กลับ</button>
                        <div className="flex items-center justify-center text-center relative mb-6">
                            <button onClick={onPrevDay} className="p-2 rounded-full text-gray-800 dark:text-white hover:bg-black/10 transition-colors"><ChevronLeftIcon /></button>
                            <div className="mx-4">
                                <h2 className="text-3xl font-bold text-gray-800 dark:text-white">วันที่ {day} {monthNames[month - 1]} {year}</h2>
                                <p className="text-slate-500 dark:text-slate-400 mt-1">บันทึกรายการแท็กงาน</p>
                            </div>
                            <button onClick={onNextDay} className="p-2 rounded-full text-gray-800 dark:text-white hover:bg-black/10 transition-colors"><ChevronRightIcon /></button>
                        </div>
                        <TaskForm 
                            taskToEdit={taskToEdit} 
                            onSave={handleSaveTask} 
                            onCancelEdit={() => setTaskToEdit(null)} 
                            suggestionsSource={suggestionsSource} 
                            onManageFrequentTasks={onManageFrequentTasks} 
                            onBatchAdd={onBatchAdd} 
                        />
                        <div className="relative z-10 flex-grow">
                            <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                <h3 className="text-xl font-bold text-gray-800 dark:text-white">รายการทั้งหมด ({sortedAndFilteredTasks.length})</h3>
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center">
                                        <label htmlFor="sort-tasks" className="text-sm font-medium text-slate-700 dark:text-slate-300 mr-2">เรียงตาม:</label>
                                        <select id="sort-tasks" value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="p-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-gray-800 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-sky-500 dark:focus:ring-amber-500 focus:outline-none">
                                            <option value="default">ลำดับที่เพิ่ม</option>
                                            <option value="status">สถานะ</option>
                                            <option value="room">เลขห้อง</option>
                                        </select>
                                    </div>
                                    <div className="relative w-full max-w-xs sm:max-w-sm">
                                        <input type="text" placeholder="ค้นหารายการ..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="p-2 pl-10 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-gray-800 dark:text-white rounded-lg w-full focus:ring-2 focus:ring-sky-500 dark:focus:ring-amber-500 focus:outline-none"/>
                                        <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><SearchIcon /></div>
                                    </div>
                                </div>
                            </div>
                            {sortedAndFilteredTasks.length === 0 ? (
                                <div className="text-center text-slate-400 py-12 bg-slate-50 dark:bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-700">
                                    <p className="font-semibold">{searchTerm ? 'ไม่พบรายการที่ตรงกัน' : 'ยังไม่มีรายการสำหรับวันนี้'}</p>
                                    <p className="text-sm">{searchTerm ? 'ลองใช้คำค้นหาอื่น' : 'เพิ่มรายการแรกของคุณโดยใช้ฟอร์มด้านบน'}</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700 shadow-2xl">
                                    <table className="min-w-full bg-white dark:bg-slate-800">
                                        <thead className="bg-slate-50 dark:bg-slate-900/50">
                                            <tr>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">ลำดับ</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">ห้อง</th>
                                                <th className="py-2 px-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">รายการซ่อม</th>
                                                <th className="py-2 px-3 text-center text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">สถานะ</th>
                                                <th className="py-2 px-3 text-center text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wider">จัดการ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                                            {sortedAndFilteredTasks.map((task, index) => {
                                                const statusInfo = STATUSES[task.status] || STATUSES.hold;
                                                return (
                                                <tr key={task.id} className={`${statusInfo.rowColor} ${statusInfo.rowHover} transition-colors`}>
                                                    <td className="py-2 px-3 text-slate-700 dark:text-slate-300 font-medium">{index + 1}</td>
                                                    <td className="py-2 px-3 text-slate-900 dark:text-white">{task.room}</td>
                                                    <td className="py-2 px-3 text-slate-600 dark:text-slate-300">{task.description}</td>
                                                    <td className="py-2 px-3 text-center">
                                                        <div className="flex items-center justify-center gap-1 flex-wrap">
                                                            {STATUS_CYCLE.map(statusKey => {
                                                                const isCurrentStatus = task.status === statusKey;
                                                                const btnStatusInfo = STATUSES[statusKey];
                                                                return (
                                                                    <button 
                                                                        key={statusKey}
                                                                        onClick={() => handleStatusChange(task, statusKey)}
                                                                        className={`font-bold py-1 px-3 rounded-full text-xs transition-all duration-200 transform
                                                                            ${isCurrentStatus 
                                                                                ? `${btnStatusInfo.color} scale-105 shadow-lg` 
                                                                                : `bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-600 dark:text-slate-300 dark:hover:bg-slate-700 opacity-60 hover:opacity-100`
                                                                            }`
                                                                        }
                                                                    >
                                                                        {btnStatusInfo.text}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </td>
                                                    <td className="py-2 px-3 text-center flex justify-center items-center gap-2">
                                                        <button onClick={() => setTaskToEdit(task)} className="text-slate-400 hover:text-sky-500 dark:hover:text-amber-400 p-2 rounded-full transition-colors duration-200"><EditIcon /></button>
                                                        <button onClick={() => handleCopyDescription(task.description)} className="text-slate-400 hover:text-green-500 dark:hover:text-green-400 p-2 rounded-full transition-colors duration-200"><CopyIcon /></button>
                                                        <button onClick={() => setTaskToDelete(task)} className="text-slate-400 hover:text-red-500 dark:hover:text-red-400 p-2 rounded-full transition-colors duration-200"><TrashIcon /></button>
                                                    </td>
                                                </tr>
                                            )})}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const DaysView = ({ year, month, tasks, onSelectDay, onBack, onExport }) => {
            const [searchQuery, setSearchQuery] = useState('');

            const searchResults = useMemo(() => {
                if (!searchQuery) return [];
                const results = [];
                for (let day = 1; day <= getDaysInMonth(year, month); day++) {
                    const taskKey = `${year}-${month}-${day}`;
                    if (tasks[taskKey]) {
                        tasks[taskKey].forEach(task => {
                            if (task.room.toLowerCase().includes(searchQuery.toLowerCase()) || task.description.toLowerCase().includes(searchQuery.toLowerCase())) {
                                results.push({ ...task, day });
                            }
                        });
                    }
                }
                return results;
            }, [tasks, searchQuery, year, month]);
            
            const monthlySummary = useMemo(() => {
                const summary = { total: 0, ...Object.fromEntries(STATUS_CYCLE.map(key => [key, 0])) };
                Object.keys(tasks).forEach(key => {
                    const [taskYear, taskMonth] = key.split('-').map(Number);
                    if (taskYear === year && taskMonth === month) {
                        tasks[key].forEach(task => {
                            summary.total++;
                            if (summary[task.status] !== undefined) summary[task.status]++;
                        });
                    }
                });
                return summary;
            }, [tasks, year, month]);
            
            const days = Array.from({ length: getDaysInMonth(year, month) }, (_, i) => i + 1);

            return (
                <div className="p-6 md:p-8 min-h-screen">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={onBack} className="flex items-center bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white font-bold py-2 px-4 rounded-full transition-all duration-300 z-10 shadow-md"><BackArrowIcon /> กลับ</button>
                            {monthlySummary.total > 0 && (<button onClick={() => onExport(year, month)} className="flex items-center bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-300 z-10 shadow-sm"><ExportIcon /> ส่งออกเป็น Excel</button>)}
                        </div>
                        <div className="text-center">
                            <h2 className="text-3xl font-bold text-slate-800 dark:text-white">{monthNames[month - 1]}</h2>
                            <p className="text-slate-500 dark:text-slate-400">{year}</p>
                        </div>
                        
                        <div className="relative my-6">
                            <input type="text" placeholder="ค้นหางานทั้งหมดในเดือนนี้..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="p-3 pl-10 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 text-slate-800 dark:text-white rounded-full w-full focus:ring-2 focus:ring-sky-500 dark:focus:ring-amber-500 focus:outline-none"/>
                            <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><SearchIcon /></div>
                        </div>

                        {searchQuery ? (
                            <div>
                                <h3 className="text-xl font-bold text-slate-700 dark:text-white mb-4">ผลการค้นหา ({searchResults.length})</h3>
                                {searchResults.length > 0 ? (
                                    <div className="space-y-3">
                                        {searchResults.map(task => {
                                            const statusInfo = STATUSES[task.status] || STATUSES.hold;
                                            return (
                                                <div key={task.id} onClick={() => onSelectDay(task.day)} className={`p-3 rounded-lg flex justify-between items-center cursor-pointer bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700`}>
                                                    <div>
                                                        <p className="font-bold text-slate-800 dark:text-white">วันที่ {task.day} - ห้อง: {task.room}</p>
                                                        <p className="text-slate-600 dark:text-slate-300">{task.description}</p>
                                                    </div>
                                                    <span className={`font-bold py-1 px-3 rounded-full text-sm ${statusInfo.color}`}>{statusInfo.text}</span>
                                                </div>
                                            )
                                        })}
                                    </div>
                                ) : (
                                    <p className="text-center text-slate-500 dark:text-slate-400 py-8">ไม่พบรายการที่ตรงกับ "{searchQuery}"</p>
                                )}
                            </div>
                        ) : (
                            <>
                                {monthlySummary.total > 0 && (
                                    <div className="mt-6 p-4 bg-white/60 dark:bg-slate-800/50 backdrop-blur-xl rounded-xl border border-slate-200 dark:border-slate-700 shadow-2xl flex flex-wrap justify-center gap-x-6 gap-y-4 text-center">
                                        <div><p className="text-2xl font-bold text-slate-800 dark:text-white">{monthlySummary.total}</p><p className="text-sm text-slate-500 dark:text-slate-400">งานทั้งหมด</p></div>
                                        <div><p className="text-2xl font-bold text-yellow-500 dark:text-yellow-400">{monthlySummary.pending}</p><p className="text-sm text-slate-500 dark:text-slate-400">กำลังแท็ก</p></div>
                                        <div><p className="text-2xl font-bold text-emerald-500 dark:text-emerald-400">{monthlySummary.done}</p><p className="text-sm text-slate-500 dark:text-slate-400">แท็กได้</p></div>
                                        <div><p className="text-2xl font-bold text-slate-500 dark:text-slate-300">{monthlySummary.hold}</p><p className="text-sm text-slate-500 dark:text-slate-400">ยังไม่แท็ก</p></div>
                                        <div><p className="text-2xl font-bold text-red-500 dark:text-red-400">{monthlySummary.cannot}</p><p className="text-sm text-slate-500 dark:text-slate-400">แท็กไม่ได้</p></div>
                                    </div>
                                )}
                                <div className="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-7 lg:grid-cols-8 xl:grid-cols-10 gap-3 mt-8">
                                    {days.map(day => {
                                        const taskKey = `${year}-${month}-${day}`;
                                        const dayTasks = tasks[taskKey];
                                        let indicator = null;
                                        if (dayTasks && dayTasks.length > 0) {
                                            const allDone = dayTasks.every(task => task.status === 'done');
                                            if (allDone) {
                                                indicator = (<span className="absolute bottom-1 right-1 w-5 h-5 bg-emerald-500 text-white text-sm font-bold rounded-full flex items-center justify-center border-2 border-white dark:border-slate-800 leading-none">✓</span>);
                                            } else {
                                                indicator = (<span className="absolute bottom-1 right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center border-2 border-white dark:border-slate-800 animate-pulse">!</span>);
                                            }
                                        }
                                        return (<button key={day} onClick={() => onSelectDay(day)} className="relative bg-white dark:bg-slate-800 hover:bg-sky-100 dark:hover:bg-slate-700 text-slate-700 dark:text-white font-bold py-3 px-2 rounded-lg aspect-square flex items-center justify-center transition-all duration-300 shadow-md hover:shadow-lg dark:hover:text-amber-400 transform hover:-translate-y-1 border border-slate-200 dark:border-slate-700">{day}{indicator}</button>);
                                    })}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const MonthsView = ({ year, onSelectMonth, onBack }) => {
            return (
                <div className="p-6 md:p-8 min-h-screen">
                    <div className="max-w-7xl mx-auto">
                        <button onClick={onBack} className="flex items-center bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-800 dark:text-white font-bold py-2 px-4 rounded-full transition-all duration-300 z-10 shadow-md mb-4"><BackArrowIcon /> กลับ</button>
                        <div className="text-center">
                            <h2 className="text-3xl font-bold text-slate-800 dark:text-white">เลือกเดือน</h2>
                            <p className="text-slate-500 dark:text-slate-400">ปี {year}</p>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-8">
                            {monthNames.map((name, index) => {
                                const monthNumber = index + 1;
                                const isDisabled = year === 2025 && monthNumber <= 7;
                                return (<button key={name} onClick={() => !isDisabled && onSelectMonth(monthNumber)} disabled={isDisabled} className={`p-6 rounded-xl font-semibold text-lg transition-all duration-300 shadow-lg disabled:shadow-none disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:text-slate-500 dark:disabled:text-slate-500 disabled:cursor-not-allowed ${isDisabled ? '' : 'bg-white dark:bg-slate-800 hover:bg-sky-500 dark:hover:bg-slate-700 text-sky-600 dark:text-white border-2 border-sky-500 dark:border-slate-700 transform hover:-translate-y-1 dark:hover:shadow-amber-500/20 dark:hover:border-amber-500'}`}>{name}</button>);
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const MainMenu = ({ onSelectYear, frequentTaskStats }) => {
            return (
                <div className="flex flex-col items-center justify-center w-full min-h-screen p-4 text-center">
                    <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-sky-500 to-blue-600 dark:from-amber-400 dark:to-amber-200 mb-3 py-2">แท็กงานของมิ้ว</h1>
                    <p className="text-slate-600 dark:text-slate-400 text-lg md:text-xl mb-12">ศูนย์บัญชาการ (Mission Control)</p>
                    
                    <div className="w-full max-w-4xl mx-auto">
                        <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">รายการซ่อมที่พบบ่อยที่สุด</h2>
                        <div className="bg-white/60 dark:bg-slate-800/50 backdrop-blur-xl p-4 rounded-2xl shadow-lg border border-gray-200/80 dark:border-slate-700 mb-8">
                            {frequentTaskStats.length > 0 ? (
                                <ol className="space-y-2 text-left">
                                    {frequentTaskStats.map(([description, count], index) => (
                                        <li key={description} className="p-3 rounded-lg flex justify-between items-center hover:bg-gray-100 dark:hover:bg-slate-700">
                                            <div className="flex items-center">
                                                <span className="font-bold text-slate-500 dark:text-slate-400 w-8">{index + 1}.</span>
                                                <span className="text-slate-800 dark:text-white">{description}</span>
                                            </div>
                                            <span className="font-bold py-1 px-3 rounded-full text-sm bg-sky-100 text-sky-700 dark:bg-amber-400/20 dark:text-amber-300">{count} ครั้ง</span>
                                        </li>
                                    ))}
                                </ol>
                            ) : (
                                <p className="text-slate-500 dark:text-slate-400 py-4">ยังไม่มีข้อมูลเพียงพอที่จะแสดงผล</p>
                            )}
                        </div>
                    </div>

                    <div className="flex gap-4">
                        <button onClick={() => onSelectYear(2025)} className="bg-gradient-to-br from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 dark:from-amber-400 dark:to-amber-500 dark:hover:from-amber-500 dark:hover:to-amber-600 text-white font-bold py-4 px-16 rounded-full text-2xl shadow-2xl shadow-sky-500/40 hover:shadow-sky-500/60 dark:shadow-amber-500/20 dark:hover:shadow-amber-400/40 transform hover:scale-110 transition-all duration-300">
                            2025
                        </button>
                        <button onClick={() => onSelectYear(2026)} className="bg-gradient-to-br from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 dark:from-amber-400 dark:to-amber-500 dark:hover:from-amber-500 dark:hover:to-amber-600 text-white font-bold py-4 px-16 rounded-full text-2xl shadow-2xl shadow-sky-500/40 hover:shadow-sky-500/60 dark:shadow-amber-500/20 dark:hover:shadow-amber-400/40 transform hover:scale-110 transition-all duration-300">
                            2026
                        </button>
                    </div>
                </div>
            );
        };


        const App = () => {
            const [view, setView] = useState('main');
            const [selectedYear, setSelectedYear] = useState(null);
            const [selectedMonth, setSelectedMonth] = useState(null);
            const [selectedDay, setSelectedDay] = useState(null);
            const [notification, setNotification] = useState(null);
            const [isManageFrequentOpen, setIsManageFrequentOpen] = useState(false);
            const [theme, setTheme] = useState(() => localStorage.getItem('mew-theme') || 'light');

            const [tasks, setTasks] = useState(() => {
                try {
                    const localData = localStorage.getItem('mew-tasks-data');
                    return localData ? JSON.parse(localData) : {};
                } catch (error) {
                    console.error("Error reading tasks from local storage", error);
                    return {};
                }
            });
            const [frequentTasks, setFrequentTasks] = useState(() => {
                try {
                    const localData = localStorage.getItem('mew-frequent-tasks-data');
                    return localData ? JSON.parse(localData) : DEFAULT_FREQUENT_TASKS;
                } catch (error) {
                    return DEFAULT_FREQUENT_TASKS;
                }
            });

            // สร้างแหล่งข้อมูลสำหรับคำแนะนำทั้งหมด (จากรายการใช้บ่อย + รายการที่เคยเพิ่ม)
            const suggestionsSource = useMemo(() => {
                const allDescriptions = new Set(frequentTasks);
                Object.values(tasks).forEach(dayTasks => {
                    dayTasks.forEach(task => {
                        if (task.description) {
                            allDescriptions.add(task.description.trim());
                        }
                    });
                });
                return Array.from(allDescriptions).sort();
            }, [tasks, frequentTasks]);

            useEffect(() => {
                const root = window.document.documentElement;
                if (theme === 'dark') {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
                localStorage.setItem('mew-theme', theme);
            }, [theme]);

            useEffect(() => {
                try {
                    localStorage.setItem('mew-tasks-data', JSON.stringify(tasks));
                    localStorage.setItem('mew-frequent-tasks-data', JSON.stringify(frequentTasks));
                } catch (error) {
                    console.error("Error saving data to local storage", error);
                }
            }, [tasks, frequentTasks]);

            useEffect(() => {
                let attentionCount = 0;
                Object.values(tasks).forEach(dayTasks => {
                    dayTasks.forEach(task => {
                        if (task.status !== 'done') {
                            attentionCount++;
                        }
                    });
                });
                if (attentionCount > 0) {
                    document.title = `(${attentionCount}) แท็กงานของมิ้ว`;
                } else {
                    document.title = 'แท็กงานของมิ้ว';
                }
            }, [tasks]);

            const showNotification = (message, type = 'success') => setNotification({ message, type });
            const handleSelectYear = (year) => { setSelectedYear(year); setView('months'); };
            const handleSelectMonth = (month) => { setSelectedMonth(month); setView('days'); };
            const handleSelectDay = (day) => { setSelectedDay(day); setView('tasks'); };

            const handleAddTask = (newTask) => {
                const taskKey = `${selectedYear}-${selectedMonth}-${selectedDay}`;
                setTasks(prevTasks => {
                    const currentDayTasks = prevTasks[taskKey] || [];
                    return { ...prevTasks, [taskKey]: [...currentDayTasks, newTask] };
                });
            };

            const handleBatchAdd = (multiLineText) => {
                const lines = multiLineText.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) return;

                const newTasks = lines.map((line, index) => {
                    const roomRegexWithWord = /(?:ห้อง|room)\s*([0-9A-Za-z-]+)/i;
                    const roomRegexJustNumber = /^([0-9A-Za-z-]+)\s+(.+)/;
                    let room = 'N/A';
                    let description = line.trim();

                    let match = line.match(roomRegexWithWord);
                    if (match) {
                        room = match[1];
                        description = line.replace(match[0], '').trim();
                    } else {
                        match = line.match(roomRegexJustNumber);
                        if (match) {
                            room = match[1];
                            description = match[2].trim();
                        }
                    }
                    
                    return { id: Date.now() + index, room, description, status: 'hold' };
                });

                const taskKey = `${selectedYear}-${selectedMonth}-${selectedDay}`;
                setTasks(prevTasks => {
                    const currentDayTasks = prevTasks[taskKey] || [];
                    return { ...prevTasks, [taskKey]: [...currentDayTasks, ...newTasks] };
                });

                showNotification(`${newTasks.length} รายการถูกเพิ่มแล้ว`);
            };

            const handleUpdateTask = (updatedTask) => {
                const taskKey = `${selectedYear}-${selectedMonth}-${selectedDay}`;
                setTasks(prevTasks => {
                    const currentDayTasks = prevTasks[taskKey] || [];
                    const newDayTasks = currentDayTasks.map(task => task.id === updatedTask.id ? updatedTask : task);
                    return { ...prevTasks, [taskKey]: newDayTasks };
                });
            };
            
            const handleDeleteTask = (taskId) => {
                const taskKey = `${selectedYear}-${selectedMonth}-${selectedDay}`;
                setTasks(prevTasks => {
                    const currentDayTasks = prevTasks[taskKey] || [];
                    const newDayTasks = currentDayTasks.filter(task => task.id !== taskId);
                    return { ...prevTasks, [taskKey]: newDayTasks };
                });
            };

            const handleAddFrequentTask = (item) => setFrequentTasks(prev => [...prev, item]);
            const handleDeleteFrequentTask = (item) => setFrequentTasks(prev => prev.filter(i => i !== item));

            const handleDateChange = (offset) => {
                const currentDate = new Date(selectedYear, selectedMonth - 1, selectedDay);
                currentDate.setDate(currentDate.getDate() + offset);
                setSelectedYear(currentDate.getFullYear());
                setSelectedMonth(currentDate.getMonth() + 1);
                setSelectedDay(currentDate.getDate());
            };

            const handleExportCSV = (year, month) => {
                const headers = ["วันที่", "ห้อง", "รายการซ่อม", "สถานะ"];
                let csvRows = [headers.join(',')];
                for (let day = 1; day <= getDaysInMonth(year, month); day++) {
                    const taskKey = `${year}-${month}-${day}`;
                    if (tasks[taskKey] && tasks[taskKey].length > 0) {
                        
                        csvRows.push(''); // Add a blank row separator
                        const dayHeader = `--- วันที่ ${day} ${monthNames[month - 1]} ${year} ---`;
                        csvRows.push(`"${dayHeader}"`);
                        
                        tasks[taskKey].forEach(task => {
                            const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            const room = task.room;
                            const description = `"${task.description.replace(/"/g, '""')}"`;
                            const status = STATUSES[task.status]?.text || task.status;
                            csvRows.push([date, room, description, status].join(','));
                        });
                    }
                }
                
                const csvString = csvRows.join('\n');
                const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `แท็กงาน-${year}-${String(month).padStart(2, '0')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const goBackToMain = () => { setView('main'); setSelectedYear(null); setSelectedMonth(null); setSelectedDay(null); };
            const goBackToMonths = () => { setView('months'); setSelectedDay(null); };
            const goBackToDays = () => { setView('days'); setSelectedDay(null); };

            const frequentTaskStats = useMemo(() => {
                const descriptionCounts = {};
                Object.values(tasks).forEach(dayTasks => {
                    dayTasks.forEach(task => {
                        const desc = task.description.trim();
                        if (desc) {
                            descriptionCounts[desc] = (descriptionCounts[desc] || 0) + 1;
                        }
                    });
                });

                return Object.entries(descriptionCounts)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 10);
            }, [tasks]);

            const renderContent = () => {
                switch (view) {
                    case 'tasks':
                        const taskKey = `${selectedYear}-${selectedMonth}-${selectedDay}`;
                        return <TaskView 
                                    year={selectedYear} 
                                    month={selectedMonth} 
                                    day={selectedDay} 
                                    tasksForDay={tasks[taskKey] || []} 
                                    onAddTask={handleAddTask} 
                                    onUpdateTask={handleUpdateTask} 
                                    onDeleteTask={handleDeleteTask} 
                                    onBatchAdd={handleBatchAdd} 
                                    onBack={goBackToDays} 
                                    onPrevDay={() => handleDateChange(-1)} 
                                    onNextDay={() => handleDateChange(1)} 
                                    showNotification={showNotification} 
                                    frequentTasks={frequentTasks} 
                                    onManageFrequentTasks={() => setIsManageFrequentOpen(true)}
                                    suggestionsSource={suggestionsSource}
                                />;
                    case 'days':
                        return <DaysView year={selectedYear} month={selectedMonth} tasks={tasks} onSelectDay={handleSelectDay} onBack={goBackToMonths} onExport={handleExportCSV} />;
                    case 'months':
                        return <MonthsView year={selectedYear} onSelectMonth={handleSelectMonth} onBack={goBackToMain} />;
                    default:
                        return <MainMenu 
                            onSelectYear={handleSelectYear} 
                            frequentTaskStats={frequentTaskStats}
                        />;
                }
            };

            return (
                <div className="w-full min-h-screen bg-gradient-to-br from-sky-50 to-blue-100 dark:from-gray-800 dark:to-gray-900 text-slate-800 dark:text-sky-300 relative">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    <ManageFrequentTasksModal isOpen={isManageFrequentOpen} onClose={() => setIsManageFrequentOpen(false)} frequentTasks={frequentTasks} onAdd={handleAddFrequentTask} onDelete={handleDeleteFrequentTask} />
                    {renderContent()}
                    <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="fixed top-5 right-5 z-50 bg-white/80 dark:bg-slate-700/80 backdrop-blur-lg p-3 rounded-full shadow-lg text-yellow-500 dark:text-yellow-400">
                        {theme === 'light' ? <MoonIcon /> : <SunIcon />}
                    </button>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
